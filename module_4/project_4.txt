Задание 4.1
База данных содержит список аэропортов практически всех крупных городов России. В большинстве городов есть только один аэропорт. Исключение составляет:
SELECT a.city,
       count(a.airport_code)
FROM dst_project.airports a
GROUP BY a.city
ORDER BY count(a.airport_code) DESC

Задание 4.2

Вопрос 1. Таблица рейсов содержит всю информацию о прошлых, текущих и запланированных рейсах. Сколько всего статусов для рейсов определено в таблице?
SELECT count(DISTINCT (f.status))
FROM dst_project.flights f

Вопрос 2. Какое количество самолетов находятся в воздухе на момент среза в базе (статус рейса «самолёт уже вылетел и находится в воздухе»).
SELECT count(f.status)
FROM dst_project.flights f
WHERE f.status = 'Departed'

Вопрос 3. Места определяют схему салона каждой модели. Сколько мест имеет самолет модели  (Boeing 777-300)?
SELECT COUNT (DISTINCT (s.seat_no))
FROM dst_project.seats s
WHERE s.aircraft_code = '773'

Вопрос 4. Сколько состоявшихся (фактических) рейсов было совершено между 1 апреля 2017 года и 1 сентября 2017 года?
SELECT count(f.status)
FROM dst_project.flights f
WHERE f.status = 'Arrived'
  AND f.actual_arrival BETWEEN '2017-04-01' AND '2017-09-01'

Задание 4.3
Вопрос 1. Сколько всего рейсов было отменено по данным базы?
SELECT count(f.status)
FROM dst_project.flights f
WHERE f.status = 'Cancelled'

Вопрос 2. Сколько самолетов моделей типа Boeing, Sukhoi Superjet, Airbus находится в базе авиаперевозок?

Boeing
SELECT count(a.aircraft_code)
FROM dst_project.aircrafts a
WHERE a.model::text like '%Boeing%'

Sukhoi Superjet
SELECT count(a.aircraft_code)
FROM dst_project.aircrafts a
WHERE a.model::text like '%Sukhoi Superjet%'

Airbus
SELECT count(a.aircraft_code)
FROM dst_project.aircrafts a
WHERE a.model::text like '%Airbus%'

Вопрос 3. В какой части (частях) света находится больше аэропортов?
SELECT count(a.timezone) 
FROM dst_project.airports a
WHERE a.timezone::text like '%Europe%'

SELECT count(a.timezone) 
FROM dst_project.airports a
WHERE a.timezone::text like '%Australia%'

SELECT count(a.timezone) 
FROM dst_project.airports a
WHERE a.timezone::text like '%Europe, Asia%'

SELECT count(a.timezone) 
FROM dst_project.airports a
WHERE a.timezone::text like '%Asia%'


Вопрос 4. У какого рейса была самая большая задержка прибытия за все время сбора данных? Введите id рейса (flight_id).

SELECT (f.actual_arrival - f.scheduled_arrival) AS delay,
       f.flight_id
FROM dst_project.flights f
WHERE f.actual_arrival IS NOT NULL
ORDER BY delay DESC


Задание 4.4

Вопрос 1. Когда был запланирован самый первый вылет, сохраненный в базе данных?

SELECT min(f.scheduled_departure)
FROM dst_project.flights f


нет ответа
Вопрос 2. Сколько минут составляет запланированное время полета в самом длительном рейсе?

SELECT max(date_part('hour', f.scheduled_arrival - f.scheduled_departure) * 60 + date_part('minute', f.scheduled_arrival - f.scheduled_departure))
FROM dst_project.flights f

Вопрос 3. Между какими аэропортами пролегает самый длительный по времени запланированный рейс?


SELECT date_part('hour', f.scheduled_arrival - f.scheduled_departure) * 60 + date_part('minute', f.scheduled_arrival - f.scheduled_departure) AS long,
       f.departure_airport,
       f.arrival_airport
FROM dst_project.flights f
ORDER BY long DESC

Вопрос 4. Сколько составляет средняя дальность полета среди всех самолетов в минутах? Секунды округляются в меньшую сторону (отбрасываются до минут).

SELECT avg(date_part('hour', f.scheduled_arrival - f.scheduled_departure) * 60 + date_part('minute', f.scheduled_arrival - f.scheduled_departure)) AS long
FROM dst_project.flights f

Задание 4.5

Вопрос 1. Мест какого класса у SU9 больше всего?

SELECT COUNT (s.seat_no), s.fare_conditions
FROM dst_project.seats s
WHERE s.aircraft_code = 'SU9'
GROUP BY s.fare_conditions
ORDER BY s.fare_conditions DESC

Вопрос 2. Какую самую минимальную стоимость составило бронирование за всю историю?

SELECT MIN (b.total_amount)
FROM dst_project.bookings b


Вопрос 3. Какой номер места был у пассажира с id = 4313 788533?

SELECT b.seat_no
FROM dst_project.boarding_passes b
JOIN dst_project.tickets t ON b.ticket_no = t.ticket_no
WHERE t.passenger_id = '4313 788533'

Задание 5.1

Вопрос 1. Анапа — курортный город на юге России. Сколько рейсов прибыло в Анапу за 2017 год?


SELECT count(*)
FROM dst_project.flights f
INNER JOIN dst_project.airports a ON f.arrival_airport = a.airport_code
WHERE (date_part('year', actual_arrival) = 2017)
  AND a.city='Anapa'
  AND f.actual_arrival IS NOT NULL

Вопрос 2. Сколько рейсов из Анапы вылетело зимой 2017 года?

SELECT count(*)
FROM dst_project.flights f
INNER JOIN dst_project.airports a ON f.departure_airport = a.airport_code
WHERE date_part('year', actual_departure) = 2017
  AND date_part('month'::text, f.actual_departure)::integer IN (1,
                                                                2,
                                                                12)
  AND a.city='Anapa'
  AND f.actual_departure IS NOT NULL

Вопрос 3. Посчитайте количество отмененных рейсов из Анапы за все время.

SELECT count(*)
FROM dst_project.flights f
INNER JOIN dst_project.airports a ON f.departure_airport = a.airport_code
WHERE a.city='Anapa'
  AND f.status = 'Cancelled'



Вопрос 4. Сколько рейсов из Анапы не летают в Москву?

SELECT count(DISTINCT f.flight_id)
FROM dst_project.flights f
WHERE arrival_airport not in ('DME',
                              'SVO',
                              'VKO')
  AND departure_airport = 'AAQ'

Вопрос 5. Какая модель самолета летящего на рейсах из Анапы имеет больше всего мест?

SELECT ar.model,ar.aircraft_code, count (distinct s.seat_no)
FROM dst_project.flights f
INNER JOIN dst_project.airports a ON f.departure_airport = a.airport_code
inner join dst_project.aircrafts ar on f.aircraft_code = ar.aircraft_code
inner join dst_project.seats s on f.aircraft_code = s.aircraft_code
where f.departure_airport = 'AAQ' 
group by 1, 2 
order by 3 desc limit 1 


Датасет

SELECT f.flight_id,
       f.arrival_airport,
       f.departure_airport,
       SUM (tf.amount) AS total,
           s.aircraft_code,
           count(s.seat_no) AS passenger,
           date_part('hour', f.scheduled_arrival - f.scheduled_departure) * 60 + date_part('minute', f.scheduled_arrival - f.scheduled_departure) AS long,
           f.actual_departure
FROM dst_project.flights f
JOIN dst_project.ticket_flights tf ON f.flight_id = tf.flight_id
JOIN dst_project.seats s ON f.aircraft_code = s.aircraft_code
WHERE departure_airport = 'AAQ'
  AND (date_trunc('month', scheduled_departure) in ('2017-01-01',
                                                    '2017-02-01',
                                                    '2017-12-01'))
  AND status not in ('Cancelled')
GROUP BY f.flight_id,
         s.aircraft_code,
         s.seat_no

Презентация
https://drive.google.com/file/d/1cNKJ3zyTIcZ94M5sNGPeBnJGrtJuQkRr/view?usp=sharing










